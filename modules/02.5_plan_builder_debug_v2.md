plan_builder.md (Final Revision)
Purpose
The Plan Builder module assembles daily itineraries from normalized activity data. It applies proximity rules, standardized cost ranges, and theme diversity to generate structured, user-friendly plans. It ensures consistent formatting, validates opening hours, and provides fallback logic for incomplete data, budget constraints, and weather-sensitive activities.

Selection Rules
Proximity Bands
Near lodging: ≤ 1 km walking distance

Close by: ≤ 2 km walking distance

Far: > 2–5 km (requires transit note)

Activities are prioritized by proximity, with fallback to farther options if nearby slots cannot be filled.

Cost Ranges
$: $0–15 per person

$$: $15–35 per person

$$$: $35–60 per person

$$$$: $60+ per person

Budget validation ensures daily totals respect user constraints. If budget is below $15/day, prioritize free and $ activities only.

Activity Themes
Each activity is tagged with one or more themes:

History & Heritage

Outdoor & Nature

Arts & Culture

Food & Drink

Family-Friendly

Specialty Tours

Afternoon slots must differ in theme from morning/midday selections to ensure variety.

Formatting Rules
Candidate lists: Always presented in tables with columns: Name, Type, Duration, Cost, Distance.

Day plans: Structured with headings and four bullets:

Morning: Near lodging

Midday: Close by

Afternoon: Different theme

Evening: Restaurant or optional event

Bold lead-ins: Apply to slot labels (e.g., Morning:).

Robustness & Fallback Logic
Missing Data
If cost, duration, or distance is unknown, annotate as “Unknown”.

Prefer activities with ≥3 known attributes.

If critical data is missing, request user input or substitute with similar nearby options.

Budget Constraints
If budget is negative or zero, select only free activities.

Annotate trade-offs when constraints force limited options.

Weather Sensitivity
Outdoor activities require indoor alternatives.

Maintain a swap list (e.g., museum for park).

Auto-swap when adverse weather is detected.

Opening Hours Validation
Validate activity slot against operating hours.

If incompatible, reorder within the day or replace with the next best candidate.

Document substitutions for transparency.

Workflow Alignment
Input contract: Requires normalized activity objects with fields: name, category, duration_min/max, price_band, lat/lon, hours.

Selection scoring: Uses upstream scoring weights; Plan Builder applies constraints and diversity rules only.

Conflict resolution: If constraints clash (e.g., all nearby options are outdoor during rain), relax proximity first, then theme, documenting the change.
